<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>System | Minimal Adaptive</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #ffffff;
            --fg: #1a1a1a;
            --sub: #a0a0a0;
            --border: #f2f2f2;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--fg); min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; }

        nav { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); background: white; position: sticky; top: 0; z-index: 100; }
        .status-dot { height: 8px; width: 8px; background: #ddd; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .connected { background: #000; box-shadow: 0 0 8px rgba(0,0,0,0.1); }

        main { display: flex; flex-direction: column; padding: 25px; gap: 30px; flex-grow: 1; }
        .section-title { font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: var(--sub); margin-bottom: 15px; display: block; }

        #main-time { font-size: clamp(4rem, 15vw, 6rem); font-weight: 200; letter-spacing: -4px; line-height: 1; }
        #main-date { font-size: 12px; color: var(--sub); margin-top: 8px; letter-spacing: 1px; }
        
        /* Grid Control */
        .controls { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .relay-btn {
            background: var(--bg); border: 1px solid var(--border); padding: 22px;
            text-align: left; cursor: pointer; border-radius: 12px; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .relay-btn.on { background: #000; color: #fff; border-color: #000; }
        .relay-btn b { display: block; font-size: 14px; margin-top: 4px; font-weight: 600; }

        /* Row Sensor */
        .sensor-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .sensor-box { padding: 20px; border: 1px solid var(--border); border-radius: 15px; background: #fafafa; }
        .sensor-label { font-size: 9px; color: var(--sub); text-transform: uppercase; letter-spacing: 1px; }
        .sensor-val { font-size: 1.8rem; font-weight: 400; margin-top: 8px; }

        /* Graph */
        .graph-wrap { height: 180px; border: 1px solid var(--border); border-radius: 15px; padding: 15px; background: #fff; }

        @media (min-width: 768px) {
            main { display: grid; grid-template-columns: 1fr 1fr; padding: 50px; }
            .full-w { grid-column: span 2; }
            .controls { grid-template-columns: repeat(4, 1fr); }
        }
    </style>
</head>
<body>

    <nav>
        <div style="font-weight: 600; font-size: 13px; letter-spacing: 1px;">ROOM</div>
        <div style="font-size: 10px; color: var(--sub); display: flex; align-items: center;">
            <span id="mqtt-dot" class="status-dot"></span>
            <span id="mqtt-text">DISCONNECTED</span>
        </div>
    </nav>

    <main>
        <section>
            <span class="section-title">Timeline</span>
            <div id="main-time">00:00</div>
            <div id="main-date">...</div>
        </section>

        <section>
            <span class="section-title">Environment</span>
            <div class="sensor-row">
                <div class="sensor-box">
                    <span class="sensor-label">Temp</span>
                    <div class="sensor-val"><span id="temp">--</span>Â°</div>
                </div>
                <div class="sensor-box">
                    <span class="sensor-label">Humi</span>
                    <div class="sensor-val"><span id="hum">--</span>%</div>
                </div>
            </div>
        </section>

        <section class="full-w">
            <span class="section-title">Switches</span>
            <div class="controls">
                <script>
                    for(let i=1; i<=4; i++) {
                        document.write(`
                            <button class="relay-btn" id="r-${i}" onclick="toggle(${i})">
                                <span style="font-size:9px; opacity:0.5;">SW.0${i}</span>
                                <b id="state-${i}">OFF</b>
                            </button>
                        `);
                    }
                </script>
            </div>
        </section>

        <section class="full-w">
            <span class="section-title">Live Trend</span>
            <div class="graph-wrap">
                <canvas id="tempChart"></canvas>
            </div>
       
        </section>
    </main>

    <script>
        const client = mqtt.connect('wss://broker.emqx.io:8084/mqtt');

        window.onload = () => {
            for(let i=1; i<=4; i++) {
                if(localStorage.getItem(`relay_v2_${i}`) === "1") updateUI(i, "1");
            }
            initChart();
            fetchIP();
        };

        function fetchIP() {
            fetch('https://api.ipify.org?format=json')
                .then(r => r.json()).then(d => document.getElementById('ip').innerText = "DEVICE_IP: " + d.ip);
        }

        function updateUI(id, state) {
            const btn = document.getElementById(`r-${id}`);
            const txt = document.getElementById(`state-${id}`);
            if(state === "1") {
                btn.classList.add('on');
                txt.innerText = "ON";
            } else {
                btn.classList.remove('on');
                txt.innerText = "OFF";
            }
        }

        function toggle(n) {
            const btn = document.getElementById(`r-${n}`);
            const newState = btn.classList.contains('on') ? "0" : "1";
            localStorage.setItem(`relay_v2_${n}`, newState);
            client.publish(`test/ulang/r${n}`, newState);
            updateUI(n, newState);
        }

        function clock() {
            const d = new Date();
            document.getElementById('main-time').innerText = d.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
            document.getElementById('main-date').innerText = d.toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'short'}).toUpperCase();
        }
        setInterval(clock, 1000); clock();

        let tempChart;
        function initChart() {
            const ctx = document.getElementById('tempChart').getContext('2d');
            tempChart = new Chart(ctx, {
                type: 'line',
                data: { labels: Array(20).fill(''), datasets: [{ data: Array(20).fill(null), borderColor: '#000', borderWidth: 1.5, pointRadius: 0, tension: 0.4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: { color: '#f8f8f8' }, ticks: { font: { size: 9 } } } } }
            });
        }

        client.on('connect', () => {
            document.getElementById('mqtt-dot').classList.add('connected');
            document.getElementById('mqtt-text').innerText = "LIVE";
            client.subscribe('test/ulang/#');
        });

        client.on('message', (topic, message) => {
            const msg = message.toString();
            if (topic === 'test/ulang/temp') {
                document.getElementById('temp').innerText = msg;
                tempChart.data.datasets[0].data.push(parseFloat(msg));
                tempChart.data.datasets[0].data.shift();
                tempChart.update('none');
            }
            if (topic === 'test/ulang/hum') document.getElementById('hum').innerText = msg;
            if (topic.startsWith('test/ulang/r')) {
                const id = topic.replace('test/ulang/r', '');
                updateUI(id, msg);
            }
        });
    </script>
</body>
</html>