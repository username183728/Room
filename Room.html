<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Room Control</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #fdfdfd;
            --fg: #1a1a1a;
            --sub: #8a8a8a;
            --border: #f0f0f0;
            --accent: #2c2c2c;
            --success: #27ae60;
            --surface: #ffffff;
            --shadow: 0 8px 30px rgba(0, 0, 0, 0.03);
        }

        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body { 
            background: var(--bg); 
            color: var(--fg); 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow-x: hidden;
        }

        /* Navigation */
        nav { 
            padding: 20px 25px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid var(--border); 
            background: var(--surface);
            position: sticky; 
            top: 0; 
            z-index: 100; 
            backdrop-filter: blur(10px);
            background: rgba(253, 253, 253, 0.85);
        }
        
        .nav-right { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
        }
        
        .status-dot { 
            height: 6px; 
            width: 6px; 
            background: #ff5e5e; 
            border-radius: 50%; 
            display: inline-block; 
            margin-right: 6px; 
        }
        
        .connected { 
            background: var(--success); 
        }
        
        /* Button Styles */
        .settings-btn, .theme-btn {
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 8px;
            width: 36px;
            height: 36px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-btn:hover, .theme-btn:hover {
            background: rgba(0, 0, 0, 0.02);
            border-color: #d0d0d0;
        }

        .settings-btn:active, .theme-btn:active {
            transform: scale(0.95);
        }

        /* Side Panel */
        #side-panel {
            position: fixed; 
            top: 0; 
            right: -110%; 
            width: 110%; 
            max-width: 100%; 
            height: 100%;
            background: var(--surface); 
            z-index: 1000; 
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: -20px 0 40px rgba(0,0,0,0.05); 
            padding: 25px; 
            overflow-y: auto;
        }
        
        #side-panel.open { 
            right: 0; 
        }
        
        .overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.3); 
            z-index: 999; 
            display: none; 
            backdrop-filter: blur(3px); 
        }
        
        .close-panel { 
            margin-bottom: 25px; 
            background: none; 
            border: none; 
            font-size: 11px; 
            font-weight: 500; 
            letter-spacing: 1px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            color: var(--sub);
            padding: 4px 0;
        }

        main { 
            display: flex; 
            flex-direction: column; 
            padding: 20px; /* Padding sedikit diperkecil */
            gap: 20px; 
            flex-grow: 1;
            width: 100%; /* Pastikan lebar 100% */
            max-width: 100%; /* Menghilangkan batasan lebar */
        }
        
        .section-title { 
            font-size: 10px; 
            text-transform: uppercase; 
            letter-spacing: 1.5px; 
            color: var(--sub); 
            margin-bottom: 16px; 
            display: block; 
            font-weight: 500;
        }

        /* Time Section */
        .time-section {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
}
        
        #main-time { 
            font-size: clamp(3.5rem, 12vw, 5rem); 
            font-weight: 300; 
            letter-spacing: -2px; 
            line-height: 1; 
        }
        
        #main-date { 
            font-size: 12px; 
            color: var(--sub); 
            margin-top: 5px; 
            letter-spacing: 0.5px; 
            font-weight: 400;
        }
        
        /* Status Tiles */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 15px;
        }
        
        .status-tile {
            background: var(--surface);
            padding: 12px 10px;
            border-radius: 12px;
            min-width: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }
        
        .tile-label {
            font-size: 7px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--sub);
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .tile-value {
            font-size: 10px;
            font-weight: 600;
            color: var(--fg);
        }
        
        .tile-value.success {
            color: var(--success);
        }
        
        /* Controls */
        .controls { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 12px; 
        }
        
        .relay-btn {
            background: var(--surface); 
            border: 1px solid var(--border); 
            padding: 22px 18px;
            text-align: left; 
            cursor: pointer; 
            border-radius: 14px; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow);
        }
        
        .relay-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.05);
        }
        
        .relay-btn.on { 
            background: var(--accent); 
            color: #fff; 
            border-color: var(--accent); 
        }
        
        .relay-btn b { 
            display: block; 
            font-size: 14px; 
            margin-top: 6px; 
            font-weight: 600; 
        }
        
        .relay-btn span {
            font-size: 9px; 
            opacity: 0.7;
            font-weight: 500;
        }

        /* Cards */
        .card-box { 
            padding: 18px; 
            border: 1px solid var(--border); 
            border-radius: 14px; 
            background: var(--surface); 
            margin-bottom: 15px; 
            box-shadow: var(--shadow);
        }
        
        .sensor-row { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
        }
        
        .sensor-label { 
            font-size: 9px; 
            color: var(--sub); 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 500;
        }
        
        .sensor-val { 
            font-size: 1.8rem; 
            font-weight: 300; 
        }

        /* Scheduler */
        .sched-row { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 12px; 
            align-items: center; 
        }
        
        .sched-row div { 
            flex: 1; 
        }
        
        input[type="time"] { 
            width: 100%; 
            padding: 8px 10px; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            font-size: 12px; 
            background: var(--surface); 
            outline: none;
            font-family: 'Inter', sans-serif;
        }
        
        input[type="time"]:focus {
            border-color: var(--accent);
        }

        /* Toggle Switch */
        .toggle-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding-top: 12px; 
            border-top: 1px solid var(--border); 
            margin-top: 8px; 
        }
        
        .switch { 
            position: relative; 
            display: inline-block; 
            width: 34px; 
            height: 18px; 
        }
        
        .switch input { 
            opacity: 0; 
            width: 0; 
            height: 0; 
        }
        
        .slider { 
            position: absolute; 
            cursor: pointer; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background-color: #e8e8e8; 
            transition: .3s; 
            border-radius: 20px; 
        }
        
        .slider:before { 
            position: absolute; 
            content: ""; 
            height: 14px; 
            width: 14px; 
            left: 2px; 
            bottom: 2px; 
            background-color: white; 
            transition: .3s; 
            border-radius: 50%; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        input:checked + .slider { 
            background-color: var(--accent); 
        }
        
        input:checked + .slider:before { 
            transform: translateX(16px); 
        }

        .badge { 
            font-size: 8px; 
            padding: 3px 8px; 
            border-radius: 10px; 
            background: #f5f5f5; 
            color: #777; 
            font-weight: 500; 
        }
        
        .badge.active { 
            background: #eafff2; 
            color: var(--success); 
        }

        .graph-wrap { 
            height: 180px; 
            border: 1px solid var(--border); 
            border-radius: 14px; 
            padding: 15px; 
            background: var(--surface); 
            box-shadow: var(--shadow);
        }

        /* Footer */
        .footer {
            padding: 15px 5px;
            text-align: center;
            font-size: 10px;
            color: var(--sub);
            border-top: 1px solid var(--border);
            background: var(--surface);
        }

        /* Responsive */
@media (min-width: 1400px) {
            main { 
                display: grid; 
                /* Mengubah grid agar lebih proposional di layar lebar */
                grid-template-columns: repeat(12, 1fr); 
                padding: 30px; 
                gap: 20px; 
            }
            
.full-w { 
                grid-column: span 12; /* Control & Chart tetap full atau bisa diatur */
            }
.controls { 
                grid-template-columns: repeat(4, 1fr); 
            }
        
            
.time-section { 
                grid-column: span 12; /* Jam tetap di atas full */
            }
            
            section:nth-of-type(2) { 
                grid-column: span 4; /* Environment (Suhu/Hum) mengambil 1/3 lebar */
            }
            #main-time {
                margin-bottom: 0;
            }
            
            .status-grid {
                display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    width: 160px;;
            }
        }

        /* Dark Mode */
        body.dark-mode {
            --bg: #0f0f0f;
            --fg: #f0f0f0;
            --sub: #8a8a8a;
            --border: #2a2a2a;
            --accent: #ffffff;
            --surface: #1a1a1a;
            --shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
        }

        body.dark-mode nav {
            background: rgba(26, 26, 26, 0.85);
        }
        
        body.dark-mode .relay-btn.on {
            background: #ffffff;
            color: #1a1a1a;
        }
        
        body.dark-mode input[type="time"] {
            background: #252525;
            color: #f0f0f0;
            border-color: #333;
        }
        
        body.dark-mode .badge {
            background: #252525;
        }
        
        body.dark-mode .badge.active {
            background: #1e3a2b;
        }
    </style>
</head>
<body>

    <div class="overlay" id="overlay" onclick="togglePanel()"></div>
    
    <!-- Side Panel -->
    <div id="side-panel">
        <button class="close-panel" onclick="togglePanel()">
            <svg viewBox="0 0 24 24" width="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            BACK
        </button>

        <span class="section-title">Automation Scheduler</span>
        
        <script>
            // Generate 4 Automation Cards
            for(let i=1; i<=4; i++) {
                document.write(`
                    <div class="card-box">
                        <span class="sensor-label" style="color:var(--accent); font-weight:500;">Channel 0${i}</span>
                        <div class="sched-row">
                            <div>
                                <span class="sensor-label">On Time</span>
                                <input type="time" id="on-time-${i}" onchange="saveSched(${i})">
                            </div>
                            <div>
                                <span class="sensor-label">Off Time</span>
                                <input type="time" id="off-time-${i}" onchange="saveSched(${i})">
                            </div>
                        </div>
                        <div class="toggle-row">
                            <span id="badge-${i}" class="badge">DISABLED</span>
                            <label class="switch">
                                <input type="checkbox" id="auto-enabled-${i}" onchange="saveSched(${i})">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                `);
            }
        </script>
        
        <p style="font-size: 9px; color: var(--sub); line-height: 1.4; text-align: center; margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--border);">
            
        </p>
    </div>

    <!-- Navigation -->
    <nav>
        <div style="font-weight: 500; font-size: 13px; letter-spacing: 0.5px;">ROOM CONTROL</div>
        <div class="nav-right">
            <div style="font-size: 10px; color: var(--sub); display: flex; align-items: center;">
                <span id="mqtt-dot" class="status-dot"></span>
                <span id="mqtt-text">CONNECTING</span>
            </div>
            <button class="theme-btn" onclick="toggleTheme()" id="theme-icon">
                <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" id="moon-icon">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            </button>
            <button class="settings-btn" onclick="togglePanel()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main>
        <!-- Time Section -->
<section class="time-section" style="display:flex; gap:25px; align-items:center;">
    
    <!-- JAM -->
    <div>
        <span class="section-title">Current Time</span>
        <div id="main-time">00:00</div>
        <div id="main-date">Loading...</div>
        
        <!-- Tambahan visual: garis aksen -->
        <div style="width:40px; height:3px; background:var(--accent); margin-top:12px; border-radius:3px;"></div>
    </div>

    <!-- STATUS GRID -->
    <div class="status-grid">

        <div class="status-tile"><span class="tile-label">CONNECTION</span><span id="mqtt-status" class="tile-value">--</span></div>
        <div class="status-tile"><span class="tile-label">LATENCY</span><span id="net-speed" class="tile-value success">-- ms</span></div>
        <div class="status-tile"><span class="tile-label">SIGNAL</span><span id="esp-rssi" class="tile-value">--</span></div>
        <div class="status-tile"><span class="tile-label">UPTIME</span><span id="uptime" class="tile-value"></span></div>
        
        <!-- TILE BARU -->
        <div class="status-tile"><span class="tile-label">DEVICE</span><span id="esp-device" class="tile-value">ESP32</span></div>
        <div class="status-tile"><span class="tile-label">MODE</span><span id="esp-mode" class="tile-value">Normal</span></div>

    </div>

</section>

        <!-- Environment Section -->
        <section>
            <span class="section-title">Environment</span>
            <div class="sensor-row">
                <div class="card-box">
                    <span class="sensor-label">Temperature</span>
                    <div class="sensor-val"><span id="temp">--</span>°C</div>
                </div>
                <div class="card-box">
                    <span class="sensor-label">Humidity</span>
                    <div class="sensor-val"><span id="hum">--</span>%</div>
                </div>
            </div>
        </section>

        <!-- Controls Section -->
        <section class="full-w">
            <span class="section-title">Device Controls</span>
            <div class="controls" id="relay-grid">
                <script>
                    for(let i=1; i<=4; i++) {
                        document.write(`
                            <button class="relay-btn" id="r-${i}" onclick="toggle(${i})">
                                <span>CHANNEL 0${i}</span>
                                <b id="state-${i}">OFF</b>
                            </button>
                        `);
                    }
                </script>
            </div>
        </section>

        <!-- Analytics Section -->
        <section class="full-w">
            <span class="section-title">Temperature Analytics</span>
            <div class="graph-wrap">
                <canvas id="tempChart"></canvas>
            </div>
        </section>
    </main>

    <div class="footer">
        Rey
    </div>

   <script>
    // MQTT Client Setup
    const client = mqtt.connect('wss://broker.emqx.io:8084/mqtt');
    let startTime = Date.now();
    let isConnected = false;
    
    // Data untuk timer persistent
    let activeTimers = {};
    let timerCheckInterval;

    // Initialize on load
    window.onload = () => {
        // Load saved relay states
        for(let i=1; i<=4; i++) {
            if(localStorage.getItem(`relay_v2_${i}`) === "1") updateUI(i, "1");
            document.getElementById(`on-time-${i}`).value = localStorage.getItem(`autoOnTime_${i}`) || "";
            document.getElementById(`off-time-${i}`).value = localStorage.getItem(`autoOffTime_${i}`) || "";
            document.getElementById(`auto-enabled-${i}`).checked = localStorage.getItem(`autoEnabled_${i}`) === "true";
            updateBadge(i);
            
            // Load timer state dari localStorage
            loadTimerState(i);
        }
        
        // Load theme preference
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') { 
            document.body.classList.add('dark-mode'); 
            updateThemeIcon(true); 
        }
        
        // Initialize components
        initChart();
        updateUptime();
        setInterval(updateUptime, 1000);
        setInterval(clock, 1000);
        clock();
        
        // Start latency check
        checkLatency();
        setInterval(checkLatency, 5000);
        
        // Start timer checker
        startTimerChecker();
        
        // Cek timer saat pertama kali load
        checkAllTimers();
    };

    // ==============================
    // SISTEM TIMER PERSISTENT
    // ==============================

    function loadTimerState(channel) {
        const timerData = localStorage.getItem(`timer_channel_${channel}`);
        if (timerData) {
            activeTimers[channel] = JSON.parse(timerData);
            console.log(`Timer channel ${channel} loaded:`, activeTimers[channel]);
        }
    }

    function saveTimerState(channel) {
        if (activeTimers[channel]) {
            localStorage.setItem(`timer_channel_${channel}`, JSON.stringify(activeTimers[channel]));
        } else {
            localStorage.removeItem(`timer_channel_${channel}`);
        }
    }

    function setTimer(channel, action, duration, unit = 'minutes') {
        // action: 'on' atau 'off'
        // duration: durasi dalam menit/detik/jam
        // unit: 'seconds', 'minutes', 'hours'
        
        // Konversi ke milidetik
        let durationMs;
        switch(unit) {
            case 'seconds':
                durationMs = duration * 1000;
                break;
            case 'minutes':
                durationMs = duration * 60000;
                break;
            case 'hours':
                durationMs = duration * 3600000;
                break;
            default:
                durationMs = duration * 60000; // default menit
        }
        
        const timerEnd = Date.now() + durationMs;
        
        activeTimers[channel] = {
            action: action,
            endTime: timerEnd,
            duration: durationMs,
            unit: unit,
            originalDuration: duration,
            createdAt: new Date().toISOString()
        };
        
        saveTimerState(channel);
        updateTimerDisplay(channel);
        showNotification(`Timer channel ${channel} diatur untuk ${action.toUpperCase()} dalam ${duration} ${unit}`);
        
        // Simpan juga ke scheduled tasks
        const targetTime = new Date(timerEnd);
        const timeString = targetTime.getHours().toString().padStart(2, '0') + ":" + 
                          targetTime.getMinutes().toString().padStart(2, '0');
        
        if (action === 'on') {
            localStorage.setItem(`timer_on_${channel}`, timeString);
        } else {
            localStorage.setItem(`timer_off_${channel}`, timeString);
        }
        
        return timerEnd;
    }

    function cancelTimer(channel) {
        if (activeTimers[channel]) {
            delete activeTimers[channel];
            saveTimerState(channel);
            updateTimerDisplay(channel);
            showNotification(`Timer channel ${channel} dibatalkan`);
            
            // Hapus scheduled tasks
            localStorage.removeItem(`timer_on_${channel}`);
            localStorage.removeItem(`timer_off_${channel}`);
        }
    }

    function checkTimer(channel) {
        if (!activeTimers[channel]) return false;
        
        const now = Date.now();
        const timer = activeTimers[channel];
        
        if (now >= timer.endTime) {
            // Timer selesai, eksekusi action
            executeTimerAction(channel, timer.action);
            
            // Hapus timer setelah dieksekusi
            delete activeTimers[channel];
            saveTimerState(channel);
            updateTimerDisplay(channel);
            
            showNotification(`Timer channel ${channel}: Relay di${timer.action === 'on' ? 'HIDUPKAN' : 'DIMATIKAN'}`);
            return true;
        }
        
        return false;
    }

    function executeTimerAction(channel, action) {
        if (action === 'on') {
            toggle(channel, "1");
        } else if (action === 'off') {
            toggle(channel, "0");
        }
    }

    function updateTimerDisplay(channel) {
        const badge = document.getElementById(`badge-${channel}`);
        if (!badge) return;
        
        if (activeTimers[channel]) {
            const timer = activeTimers[channel];
            const remaining = Math.max(0, timer.endTime - Date.now());
            const minutes = Math.floor(remaining / 60000);
            const seconds = Math.floor((remaining % 60000) / 1000);
            
            badge.innerText = `${timer.action.toUpperCase()} in ${minutes}:${seconds.toString().padStart(2, '0')}`;
            badge.classList.add('active');
            badge.style.backgroundColor = timer.action === 'on' ? '#e8f5e9' : '#ffebee';
            badge.style.color = timer.action === 'on' ? '#2e7d32' : '#c62828';
        } else {
            const isEnabled = document.getElementById(`auto-enabled-${channel}`).checked;
            badge.innerText = isEnabled ? "SCHEDULED" : "DISABLED";
            badge.className = "badge";
            if (isEnabled) badge.classList.add('active');
        }
    }

    function startTimerChecker() {
        // Hentikan interval sebelumnya jika ada
        if (timerCheckInterval) clearInterval(timerCheckInterval);
        
        // Cek timer setiap detik
        timerCheckInterval = setInterval(() => {
            for (let channel = 1; channel <= 4; channel++) {
                checkTimer(channel);
                updateTimerDisplay(channel);
            }
        }, 1000);
    }

    function checkAllTimers() {
        // Cek semua timer saat aplikasi dimulai
        for (let channel = 1; channel <= 4; channel++) {
            if (activeTimers[channel]) {
                const timer = activeTimers[channel];
                
                // Jika timer sudah expired saat load
                if (Date.now() >= timer.endTime) {
                    executeTimerAction(channel, timer.action);
                    delete activeTimers[channel];
                    saveTimerState(channel);
                    showNotification(`Timer channel ${channel} dieksekusi (dari state sebelumnya)`);
                }
            }
            updateTimerDisplay(channel);
        }
    }

    function showNotification(message) {
        // Buat notifikasi sederhana
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--accent);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 12px;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            max-width: 300px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        `;
        
        notification.innerText = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // Tambahkan style untuk animasi notifikasi
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);

    // ==============================
    // FUNGSI UI UNTUK TIMER
    // ==============================

    function openTimerDialog(channel) {
        // Dialog untuk mengatur timer
        const dialog = document.createElement('div');
        dialog.id = 'timer-dialog';
        dialog.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--surface);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            z-index: 10001;
            min-width: 300px;
            border: 1px solid var(--border);
        `;
        
        dialog.innerHTML = `
            <h3 style="margin-bottom: 20px; font-weight: 500;">Set Timer - Channel 0${channel}</h3>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-size: 11px; color: var(--sub); margin-bottom: 5px;">Action</label>
                <select id="timer-action" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: var(--surface);">
                    <option value="on">Turn ON</option>
                    <option value="off">Turn OFF</option>
                </select>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-size: 11px; color: var(--sub); margin-bottom: 5px;">Duration</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="timer-duration" value="5" min="1" max="720" 
                           style="flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: var(--surface);">
                    <select id="timer-unit" style="width: 100px; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: var(--surface);">
                        <option value="minutes">Minutes</option>
                        <option value="seconds">Seconds</option>
                        <option value="hours">Hours</option>
                    </select>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button onclick="closeTimerDialog()" style="flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: transparent; cursor: pointer;">Cancel</button>
                <button onclick="saveTimerSetting(${channel})" style="flex: 1; padding: 10px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer;">Set Timer</button>
            </div>
            
            ${activeTimers[channel] ? `
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border);">
                <div style="font-size: 11px; color: var(--sub); margin-bottom: 5px;">Active Timer:</div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 12px;">${activeTimers[channel].action.toUpperCase()} in ${getRemainingTimeText(channel)}</span>
                    <button onclick="cancelTimer(${channel}); closeTimerDialog();" style="font-size: 10px; padding: 4px 10px; background: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                </div>
            </div>
            ` : ''}
        `;
        
        // Overlay
        const overlay = document.createElement('div');
        overlay.id = 'timer-overlay';
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 10000;
        `;
        overlay.onclick = closeTimerDialog;
        
        document.body.appendChild(overlay);
        document.body.appendChild(dialog);
    }

    function getRemainingTimeText(channel) {
        if (!activeTimers[channel]) return '';
        
        const remaining = Math.max(0, activeTimers[channel].endTime - Date.now());
        const hours = Math.floor(remaining / 3600000);
        const minutes = Math.floor((remaining % 3600000) / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
        
        if (hours > 0) {
            return `${hours}h ${minutes}m`;
        } else if (minutes > 0) {
            return `${minutes}m ${seconds}s`;
        } else {
            return `${seconds}s`;
        }
    }

    function saveTimerSetting(channel) {
        const action = document.getElementById('timer-action').value;
        const duration = parseInt(document.getElementById('timer-duration').value);
        const unit = document.getElementById('timer-unit').value;
        
        if (duration < 1) {
            alert('Duration must be at least 1');
            return;
        }
        
        setTimer(channel, action, duration, unit);
        closeTimerDialog();
    }

    function closeTimerDialog() {
        const dialog = document.getElementById('timer-dialog');
        const overlay = document.getElementById('timer-overlay');
        
        if (dialog) dialog.remove();
        if (overlay) overlay.remove();
    }

    // ==============================
    // FUNGSI BANTUAN UNTUK RELAY
    // ==============================

    // Fungsi toggle relay dengan timer option
    function toggle(n, forceState = null) {
        const btn = document.getElementById(`r-${n}`);
        const newState = forceState || (btn.classList.contains('on') ? "0" : "1");
        client.publish(`test/ulang/r${n}`, newState, { retain: true });
        
        // Jika ada timer untuk relay ini, hapus
        if (activeTimers[n]) {
            cancelTimer(n);
        }
    }

    // Update relay button untuk menambahkan timer option
    function updateRelayButtons() {
        for(let i=1; i<=4; i++) {
            const btn = document.getElementById(`r-${i}`);
            const originalOnclick = btn.getAttribute('onclick');
            
            // Ubah onclick untuk menampilkan menu
            btn.setAttribute('onclick', `showRelayMenu(${i}, event)`);
            btn.style.position = 'relative';
        }
    }

    function showRelayMenu(channel, event) {
        event.preventDefault();
        event.stopPropagation();
        
        // Hapus menu yang sudah ada
        const existingMenu = document.querySelector('.relay-context-menu');
        if (existingMenu) existingMenu.remove();
        
        // Buat menu konteks
        const menu = document.createElement('div');
        menu.className = 'relay-context-menu';
        menu.style.cssText = `
            position: absolute;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 8px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 150px;
        `;
        
        menu.innerHTML = `
            <div style="padding: 8px 15px; font-size: 11px; color: var(--sub); border-bottom: 1px solid var(--border);">
                Channel 0${channel}
            </div>
            <div class="menu-item" onclick="toggle(${channel}); hideRelayMenu();" style="padding: 10px 15px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 8px;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
                Toggle Relay
            </div>
            <div class="menu-item" onclick="openTimerDialog(${channel}); hideRelayMenu();" style="padding: 10px 15px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 8px;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
                Set Timer
            </div>
            ${activeTimers[channel] ? `
            <div class="menu-item" onclick="cancelTimer(${channel}); hideRelayMenu();" style="padding: 10px 15px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 8px; color: #ff4444;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="15" y1="9" x2="9" y2="15"/>
                    <line x1="9" y1="9" x2="15" y2="15"/>
                </svg>
                Cancel Timer
            </div>
            ` : ''}
        `;
        
        // Style untuk menu items
        const style = document.createElement('style');
        style.textContent = `
            .menu-item:hover {
                background: rgba(0,0,0,0.05);
            }
            body.dark-mode .menu-item:hover {
                background: rgba(255,255,255,0.05);
            }
        `;
        document.head.appendChild(style);
        
        // Posisi menu
        const btn = document.getElementById(`r-${channel}`);
        const rect = btn.getBoundingClientRect();
        menu.style.top = `${rect.bottom + 5}px`;
        menu.style.left = `${rect.left}px`;
        
        document.body.appendChild(menu);
        
        // Click outside untuk hide menu
        setTimeout(() => {
            document.addEventListener('click', hideRelayMenu);
        }, 10);
    }

    function hideRelayMenu() {
        const menu = document.querySelector('.relay-context-menu');
        if (menu) menu.remove();
        document.removeEventListener('click', hideRelayMenu);
    }

    // ==============================
    // FUNGSI LAINNYA (SAMA SEBELUMNYA)
    // ==============================

    function updateUptime() {
        const uptimeMs = Date.now() - startTime;
        const hours = Math.floor(uptimeMs / 3600000);
        const minutes = Math.floor((uptimeMs % 3600000) / 60000);
        document.getElementById('uptime').innerText = 
            `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
    }

    function clock() {
        const d = new Date();
        document.getElementById('main-time').innerText = 
            d.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
        document.getElementById('main-date').innerText = 
            d.toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'short'}).toUpperCase();
        
        // Check automation every minute
        if (d.getSeconds() === 0) {
            const currentTime = d.getHours().toString().padStart(2, '0') + ":" + 
                               d.getMinutes().toString().padStart(2, '0');
            checkAutomation(currentTime);
        }
    }

    function checkAutomation(currentTime) {
        for(let i=1; i<=4; i++) {
            const isEnabled = document.getElementById(`auto-enabled-${i}`).checked;
            if (!isEnabled) continue;
            if (document.getElementById(`on-time-${i}`).value === currentTime) toggle(i, "1");
            if (document.getElementById(`off-time-${i}`).value === currentTime) toggle(i, "0");
        }
    }

    // MQTT Connection
    client.on('connect', () => {
        isConnected = true;
        document.getElementById('mqtt-dot').classList.add('connected');
        document.getElementById('mqtt-text').innerText = "ONLINE";
        document.getElementById('mqtt-status').innerText = "CONNECTED";
        client.subscribe('test/ulang/#');
        
        // Update relay buttons setelah koneksi
        updateRelayButtons();
    });

    client.on('error', (error) => {
        isConnected = false;
        document.getElementById('mqtt-dot').classList.remove('connected');
        document.getElementById('mqtt-text').innerText = "ERROR";
        document.getElementById('mqtt-status').innerText = "ERROR";
    });

    client.on('offline', () => {
        isConnected = false;
        document.getElementById('mqtt-dot').classList.remove('connected');
        document.getElementById('mqtt-text').innerText = "OFFLINE";
        document.getElementById('mqtt-status').innerText = "OFFLINE";
    });

    client.on('message', (topic, message) => {
        const msg = message.toString();
        
        // ESP Statistics
        if (topic === 'test/ulang/esp/rssi') document.getElementById('esp-rssi').innerText = msg + " dBm";
        if (topic === 'test/ulang/esp/cpu') document.getElementById('esp-cpu').innerText = msg + " °C";
        if (topic === 'test/ulang/esp/ram') document.getElementById('esp-ram').innerText = msg + " KB";

        // Environment Sensors
        if (topic === 'test/ulang/temp') {
            document.getElementById('temp').innerText = msg;
            if(tempChart && tempChart.data) {
                tempChart.data.datasets[0].data.push(parseFloat(msg));
                if (tempChart.data.datasets[0].data.length > 20) {
                    tempChart.data.datasets[0].data.shift();
                }
                tempChart.update('none');
            }
        }
        if (topic === 'test/ulang/hum') document.getElementById('hum').innerText = msg;

        // Relay States
        if (topic.startsWith('test/ulang/r')) {
            const id = topic.replace('test/ulang/r', '');
            updateUI(id, msg);
            localStorage.setItem(`relay_v2_${id}`, msg);
            
            // Update timer display jika relay berubah
            updateTimerDisplay(parseInt(id));
        }
    });

    function updateUI(id, state) {
        const btn = document.getElementById(`r-${id}`);
        const txt = document.getElementById(`state-${id}`);
        if (state === "1") { 
            btn.classList.add('on'); 
            txt.innerText = "ON"; 
        } else { 
            btn.classList.remove('on'); 
            txt.innerText = "OFF"; 
        }
    }

    function saveSched(i) {
        localStorage.setItem(`autoOnTime_${i}`, document.getElementById(`on-time-${i}`).value);
        localStorage.setItem(`autoOffTime_${i}`, document.getElementById(`off-time-${i}`).value);
        localStorage.setItem(`autoEnabled_${i}`, document.getElementById(`auto-enabled-${i}`).checked);
        updateBadge(i);
    }

    function updateBadge(i) {
        const el = document.getElementById(`badge-${i}`);
        const isEnabled = document.getElementById(`auto-enabled-${i}`).checked;
        const hasTimer = !!activeTimers[i];
        
        if (hasTimer) {
            // Display timer info
            updateTimerDisplay(i);
        } else {
            el.innerText = isEnabled ? "SCHEDULED" : "DISABLED";
            el.className = "badge";
            if (isEnabled) el.classList.add('active');
        }
    }

    function checkLatency() {
        const start = Date.now();
        fetch('https://www.google.com/generate_204', { mode: 'no-cors', cache: 'no-store' })
            .then(() => {
                const latency = Date.now() - start;
                document.getElementById('net-speed').innerText = latency + " ms";
            })
            .catch(() => {
                document.getElementById('net-speed').innerText = "ERR";
            });
    }

    function togglePanel() {
        const panel = document.getElementById('side-panel');
        const overlay = document.getElementById('overlay');
        panel.classList.toggle('open');
        overlay.style.display = panel.classList.contains('open') ? 'block' : 'none';
    }

    function toggleTheme() {
        const isDark = document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        updateThemeIcon(isDark);
        updateChartTheme(isDark);
    }

    function updateThemeIcon(isDark) {
        const btn = document.getElementById('theme-icon');
        btn.innerHTML = isDark ? 
            `<svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none"><circle cx="12" cy="12" r="5"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg>` : 
            `<svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`;
    }

    // Chart Functions
    let tempChart;
    function initChart() {
        const ctx = document.getElementById('tempChart').getContext('2d');
        const isDark = document.body.classList.contains('dark-mode');
        
        tempChart = new Chart(ctx, {
            type: 'line',
            data: { 
                labels: Array(20).fill(''), 
                datasets: [{ 
                    data: Array(20).fill(null), 
                    borderColor: isDark ? '#ffffff' : '#2c2c2c', 
                    borderWidth: 1.5, 
                    pointRadius: 0, 
                    tension: 0.4,
                    fill: false
                }] 
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { legend: { display: false } }, 
                scales: { 
                    x: { display: false }, 
                    y: { 
                        grid: { color: isDark ? '#2a2a2a' : '#f0f0f0' }, 
                        ticks: { font: { size: 9 }, color: isDark ? '#8a8a8a' : '#8a8a8a' }
                    } 
                },
                animation: false
            }
        });
    }

    function updateChartTheme(isDark) {
        if(tempChart) {
            tempChart.options.scales.y.grid.color = isDark ? '#2a2a2a' : '#f0f0f0';
            tempChart.options.scales.y.ticks.color = isDark ? '#8a8a8a' : '#8a8a8a';
            tempChart.data.datasets[0].borderColor = isDark ? '#ffffff' : '#2c2c2c';
            tempChart.update();
        }
    }
    
</script>
</body>
        </html>
